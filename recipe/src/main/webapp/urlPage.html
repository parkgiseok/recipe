<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>냉장고를 가져와</title>
<link href="bower_components/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
<link href="css/font.css" rel="stylesheet">
<link href="css/urlPage.css" rel="stylesheet">
<link href="css/sweetalert.css" rel="stylesheet">

<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script src="js/sweetalert.min.js"></script>
<script src="js/reply.js"></script>
<script src="bower_components/jquery/dist/jquery.js"></script>
<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script src="js/jquery.lazyload.js"></script>
<script src="js/moment.js"></script>
<script src="js/slick.min.js"></script>
<script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="bower_components/handlebars/handlebars.min.js"></script>
<script type="text/javascript" src="js/modernizr.2.5.3.min.js"></script>
<script src="js/scripts.js"></script>
<script src="js/auth.js"></script>
<script src="js/loginCheck.js"></script>
</head>

<body oncontextmenu="return false" ondragstart="return false" onselectstart="return false">
	<nav class="navbar navbar-default">
		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed"
					data-toggle="collapse" data-target="#defaultNavbar1">
					<span class="sr-only">Toggle navigation</span> <span
						class="icon-bar"></span> <span class="icon-bar"></span> <span
						class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="index.html"><img id="titleimg"
					src="img/title.PNG" /></a>
			</div>
			<div class="collapse navbar-collapse" id="defaultNavbar1">
				<form class="navbar-form navbar-left" role="search">
          <div class="form-group">
            <input type="text" value="" class="form-control" id="searchvalue"
              placeholder="예) 김치 볶음밥">
          </div>
          <a onclick='javascript:fncSubmit();' class="btn btn-default">검색</a>
        </form>
				<div class="collapse navbar-collapse"
					id="bs-example-navbar-collapse-1">
					<ul class="nav navbar-nav navbar-right">
						<li><a id="login" class="launch-modal" href="#"
							data-modal-id="modal-register1">로그인</a></li>
						<li><a id="signup" class="launch-modal" href="#"
							data-modal-id="modal-register2">회원가입</a></li>
						<li><a id="logout">로그아웃</a></li>
						<li><a id="mypage" href="member/myPage.html">마이페이지</a></li>
					</ul>

					<!-- 로그인 -->
					<!-- <form action="auth/login.do" method="post"> -->
						<div class="modal fade" id="modal-register1" tabindex="-1"
							role="dialog" aria-labelledby="modal-register-label"
							aria-hidden="true">
							<div class="modal-dialog">
								<div class="modal-content">
									<div class="modal-header">
										<button type="button" class="close" data-dismiss="modal">
											<span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
										</button>
										<h3 class="modal-title" id="modal-register-label">로그인</h3>
									</div>
									<div class="modal-body">
										<div class="form-group">
											<label class="sr-only">Id</label> <input type="text"
												placeholder="ID" class="form-id form-control" id="mem_id" name="id">
										</div>
										<div class="form-group">
											<label class="sr-only">Password</label> <input
												type="password" placeholder="Password"
												class="form-password form-control" id="mem_pwd" name="password">
										</div>
										<button class="log_btn btn">로그인</button>
									</div>
								</div>
							</div>
						</div>
					<!-- </form> -->
					
					<!-- 회원가입 -->
					<form action="auth/add_URL.do" method="post" id="test_form">
						<div class="modal fade" id="modal-register2" tabindex="-1"
							role="dialog" aria-labelledby="modal-register-label"
							aria-hidden="true">
							<div class="modal-dialog">
								<div class="modal-content">
									<div class="modal-header">
										<button type="button" class="close" data-dismiss="modal">
											<span aria-hidden="true">&times;</span> <span class="sr-only">Close</span>
										</button>
										<h3 class="modal-title" id="modal-register-label">회원가입</h3>
									</div>
									<div class="modal-body">
										<div class="form-group">
											<label class="sr-only">Id</label> <input type="text"
												placeholder="ID" class="form-id form-control" name="id" id="jid">
										</div>
										<div class="form-group">
											<label class="sr-only">Email</label> <input type="text"
												placeholder="Email" class="form-email form-control"
												name="email" id="jemail">
										</div>
										<div class="form-group">
											<label class="sr-only">Password</label> <input
												type="password" placeholder="Password"
												class="form-password form-control" name="password" id="jPassword">
										</div>
										<button class="btn">회원가입</button>
									</div>
								</div>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
	</nav>
  <script src="js/joinCheck.js"></script>
	<div class="container">
		<div class="my_ row">
			<div class="col-xs-3 col-xs-3">
				<input id="bno" type='hidden' name='no' value=''>
				<div id="side"></div>
			</div>
			<div class="col-xs-9 col-xs-9">
			  <ul style="margin-left: -28px; margin-right: -8px; height:124px;">
			    <li class="my_list row" id="myList"></li>
			  </ul>
			  <div style="text-align:center">
          <ul class="pagination">
          </ul>
        </div>
				<div class="my_title row" id="myTitle"></div>
				<div class="my_con row" id="contt"></div>
				<div>
					<div id="review">
						<p class="detailtext">소중한 댓글</p><hr />
						<div id="reviewtext"></div><hr />
						<span id="writeReview"></span>
						<div>
							<textarea class="form-control" id="reply" cols="100" rows="4"></textarea>
							<div class="reply_btn">
								<button type="button" class="btn btn-default" id="sendReview">댓글
									등록</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<hr style="margin-top: 70px;">
	<footer>
		<div class="text-center col-xs-6 col-xs-offset-3">
			<p>
				Copyright &copy; 2016 &middot; All Rights Reserved &middot; <a
					href="http://127.0.0.1:8080/index.html">냉장고를 가져와</a>
			</p>
		</div>
	</footer>
	
<script id="reviewrepeat" type="text/x-handlebars-template">
  {{#each list}}
    <div class="reply_mem">
      <img class ="review img-rounded" src='webapp/{{photo}}'>＜{{nick}}＞ 
    </div>
    <div >
      <textarea id="review_text_{{mno}}" class="form-control review_text" cols="100" rows="2" readonly="readonly">{{r_cont}}</textarea>
    <div>
    <div id="review_{{mno}}" class="review_margin review_update_delete" data-no="{{mno}}">
      <span class="cdt review_margin" style="font-size:10px; color:gray; font-style: italic;">작성일 : {{r_w_dt}}</span>
      <button type="button" id="review_update_{{mno}}" class="reply_update btn-link" data-no="{{mno}}">
      <img src="img/write.png"></button>
      <button type="button" id="review_delete_{{mno}}" class="reply_delete btn-link" data-no="{{mno}}">
      <img src="img/trash-can.png"></button>
    </div>
  {{/each}}
</script>

<script id="mem" type="text/x-handlebars-template">   
  <div class="row">
    <img src="webapp/{{photo}}" class="my_img img-rounded" />
  </div>
  <div class="side"></div>
  <div class="row">
    <p style="color: red; margin-top: 10px; margin-bottom: -10px; font-size: 23px;">{{nick}}</p>
    <hr>
    <p class="my_intro">{{description}}</p>
  </div>
  <div class="row">
    <div class="my_intro2">
      <p style="margin: 10px 0px 0px 13px;">
      <p>성별 : <span>{{gender}}</span></p>
      <p>주카테고리 : <span>{{category}}</span></p>
      <p>E-mail : <span>{{email}}</span></p>
    </div>
  </div> 
</script>

<script id="list" type="text/x-handlebars-template">
  {{#each list}}
  <div class="col-xs-10 col-xs-10">
    <a id="list_title" href="urlPage.html?bno={{bno}}">{{title}}</a>
  </div>
  <div class="my_list_date col-xs-2">
    <p>{{w_dt}}</p>
  </div>
  {{/each}}
</script>

<script id="titlee" type="text/x-handlebars-template">
<div class="row">
  <div class="my_title_con col-xs-7">{{title}}</div>
  <div class="my_title_cate col-xs-1">
    {{c_situ}}
  </div>
  <div class="delete_update col-xs-2">
    <div class="update_delete1">
    <a id="update" class="update_delete" href="insert/update.html?bno={{bno}}">수정</a> |
    <a id="delete" class="update_delete" href="#" onclick="deleter()">삭제</a>
    </div>
    <div class="add_del">
    <a id='addbm' onclick='addfavorite()' style="display: none;"><img src="./img/favorite3.png" style="width:30px; cursor:pointer;"></a>
    <a id='delbm' onclick='delfavorite()' style="display: none;"><img src="./img/favorite1.png" style="width:30px; cursor:pointer;"></a>
    </div>
  </div>
  <div class="date col-xs-2">
    <p>{{w_dt}}</p>
  </div>
</div>
</script>

<script id="con" type="text/x-handlebars-template">
{{#each list}}
  <img src="webapp/{{p_url}}" class="my_con_img" alt="제발 제발 제발 제발 제발">
  <p>{{{cont}}}</p>
{{/each}}
</script>

	<script>
		var bno = location.href.split("=")[1];
		$("#bno").val(bno);

		// 레시피의 해당 사용자 출력
		loadMember();
		function loadMember() {
			$.getJSON("./ajax/recipe/detailMember.do?bno=" + bno, function(
					result) {
				var template = Handlebars.compile($('#mem').html());
				$("#side").append(template(result));
			});
		}
		
		/* 리스트/ 페이징처리 */
		// 이전 버튼
		function pre() {
      console.log(sessionStorage.getItem("nowpage"))
      if (sessionStorage.getItem("nowpage") > 1)
        gopage(sessionStorage.getItem("nowpage") * 1 - 1)
    }
    // 다음 버튼
    function next() {
      console.log(sessionStorage.getItem("nowpage"))
      if (sessionStorage.getItem("nowpage") < sessionStorage
          .getItem("totalPage"))
        gopage(sessionStorage.getItem("nowpage") * 1 + 1)
    }
    //recipeControl들어오면 첫화면출력
    gopage(1);
    //페이지 버튼
    function gopage(i) {
      sessionStorage.setItem("nowpage", i);
      $.getJSON("ajax/recipe/detail.do?bno=" + bno + "&pageNo=" + i,
          function(result) {
    	    console.log(result)
		    	  for (var i = 0; i< (result.list).length; i++) {
		    	      result.list[i].w_dt = moment(result.list[i].w_dt, 'MM/DD/YYYY').format()
		    	        .substr(0, 10);
		    	    }
            $("#myList").empty();
            var templateData = $("#list").html();
            var template = Handlebars.compile(templateData);
            var html = template(result);
            $("#myList").append(html);
          })
    };
    
    // paging 생성
    $(function prio(thisMenu) {
      $.getJSON("ajax/recipe/detail.do?bno=" + bno,
        function(result) {
          var pagingTag = $(".pagination");
          sessionStorage.setItem("totalPage", result.totalPage);
          $("<li>").html(
                  "<a href='javascript:pre()' aria-label='Previous'><span aria-hidden='true'>&laquo;</span></a></li>")
              .appendTo(pagingTag);
          for (var i = 1; i <= result.totalPage; i++) {
            $("<li>").html(
                "<a href='javascript:gopage(" + i
                    + ")'>" + i + "</a></li>")
                .appendTo(pagingTag);
          }
          $("<li>").html(
                  "<a href='javascript:next()' aria-label='Next'><span aria-hidden='true'>&raquo;</span></a></li>")
              .appendTo(pagingTag);
        })
    });
    /**/
    

		// 레시피 제목/카테고리/날짜 부분
		loadTitle();
		function loadTitle() {
			$.getJSON("./ajax/recipe/list.do?bno=" + bno, function(result) {
				result.w_dt = moment(result.w_dt, 'MM/DD/YYYY').format()
						.substr(0, 10);
				template = Handlebars.compile($('#titlee').html());
				$("#myTitle").append(template(result));
			});
		}

		// 레시피 내용 부분
		loadCon();
		function loadCon() {
			$.getJSON("./ajax/recipe/detailContent.do?bno=" + bno, function(
					result) {
				var template = Handlebars.compile($('#con').html());
				$("#contt").append(template(result));
			});
		}

		// 삭제버튼 누르면 확인하는 팝업
		function deleter() {
			swal({
				title : "정말 삭제하시겠습니까?",
				text : "삭제하면 작성한 내용을 복구할 수 없습니다.",
				type : "warning",
				showCancelButton : true,
				confirmButtonColor : "#DD6B55",
				confirmButtonText : "삭제하기",
				closeOnConfirm : false
			}, function() {
				swal("삭제완료", "내용이 완전히 삭제되었습니다.", "success");
				console.log("삭삭");

				$.post("ajax/recipe/delete.do", {
					bno : $("#bno").val()
				}, function(result) {
					if (result.status == "success") {
						/* location.href = "../index.html"; */
					} else {
						window.alert("등록 실패입니다 타이틀!");
					}
				}, "json");

				$(".confirm").click(function() {
					location.href = "index.html"
				})
			});
		}

		// 로그인 실패시 뜨는 팝업
		$(".log_btn").click(function() {
			$.ajax("auth/login.do?", {
				method : "POST",
				dataType : "JSON",
				data : {
					id : $("#mem_id").val(),
					password : $("#mem_pwd").val()
				},
				success : function(result) {
					if (result.status == "success") {
						location.href = "urlPage.html?bno=" + bno; 
					} else if (result.status == "failure") {
						swal({confirmButtonColor: "#DD6B55",
              title: '로그인 실패',
              text: "아이디 또는 비밀번호를 다시 확인해주세요.",
              type: 'warning'
              })
              $("#mem_id").val(""),
              $("#mem_pwd").val("")
					}
				}
			});
		})
			
		// 로그아웃 눌렀을 때, 현재 urlPage 유지하기
			$("#logout").click(function() {
	      $.ajax("auth/logout_url.do?", {
	        method : "POST",
	        dataType : "JSON",
	        data : {
	          bno : bno
	        }, success : $(function() {
	        	location.href = "urlPage.html?bno=" + bno; 
	        })
	      });
	   	})
		
		// 해당 작성 사용자가 아니면 수정 | 삭제 버튼 없애기
		$(document).ready(function() {
      $.ajax("auth/update_delete1.do?", {
        method : "POST",
        dataType : "JSON",
        data : {
          bno : bno
        },
        success : function(result) {
          if (result.status == "success") {
        	  $(".update_delete1").css("display", "");
          } else if (result.status == "failure") {
        	  $(".update_delete1").css("display", "none");
        	  $(".add_del").css("padding-top", "16px");
        	  $(".add_del").css("padding-top", "16px");
          } else {
        	  $(".update_delete1").css("display", "none");
        	  $(".add_del").css("padding-top", "16px");
        	  $(".add_del").css("padding-top", "16px");
          }
        }
      });
    })
    
    // 서치 기능
    var searchValue;
    $('input').keyup(function() {
      searchValue = $(this).val();
    });
    function fncSubmit() {
      location.href = 'search.html?value=' + searchValue;
    }
	</script>
	
	<script>
		isFavorite();
		function isFavorite() {
			$.getJSON("ajax/favorite/isFavorite.do?bno=" + bno, function(data) {
				if (data) {
					$("#delbm").css("display", "");
				} else {
					$("#addbm").css("display", "");
				}
			})
		}
		function addfavorite() {
			$.getJSON("ajax/favorite/add.do?bno=" + bno, function(data) {
				if (data.status == "success") {
					swal("즐겨찾기 완료", "즐겨찾기 리스트에 추가되었습니다.", "success")
					$(".confirm").click(function() {
						location.href = location.href;
					})
				} else {
					alert("오류발생..다시 시도해주세요.");
				}
			})
		}
		function delfavorite() {
			$.getJSON("ajax/favorite/delete.do?bno=" + bno, function(data) {
				if (data.status == "success") {

					swal({confirmButtonColor: "#DD6B55",
              title: '즐겨찾기 취소',
              text: "즐겨찾기 리스트에서 삭제되었습니다.",
              type: 'warning'})
					$(".confirm").click(function() {
						location.href = location.href;
					})

				} else {
					alert("오류발생..다시 시도해주세요.");
				}
			})
		}
	</script>

</body>
</html>
